# TCP

## TCP 头

![tpc头.jpg](https://i.loli.net/2021/03/20/xfHiLNlJ2zjCB67.jpg)
** 顺序问题 ，稳重不乱；丢包问题，承诺靠谱；连接维护，有始有终；流量控制，把握分寸；拥塞控制，知进知退。**

* 源端口号和目标端口号是不可少的，这一点和 UDP 是一样的。
* __包的序号__ 。通过给包编号，解决乱序的问题。确认哪个应该先来，哪个应该后到呢。
* __确认序号__。发出去的包应该有确认，如果没有收到就应该重新发送，直到送达。这个可以解决不丢包的问题。
* __状态位__。SYN 是发起一个连接，ACK 是回复，RST 是重新连接，FIN 是结束连接等。TCP 是面向连接的，因为双方要维护连接的状态，这些带状态位的包的发送，会引起双方的状态变更。
* __窗口大小__。TCP 要做流量控制，通信双方各声明一个窗口，标识自己当前能够的处理能力，控制发送速度。

## TCP 的三次握手
### 建立连接，各自确认双方存在
* TCP 的连接建立，我们常常称为 __三次握手__ 。
    * A：您好，我是 A。
    * B：您好 A，我是 B。
    * A：您好 B。
** 我们也常称为“请求 -> 应答 -> 应答之应答”的三个回合 **
* 三次握手，只需要双方发出的消息都有响应， a发送消息给b， b回复消息给a（a收到发送消息的响应，这个过程之后a认为可以连通b, 但b不知道是否可以连通a)。 a回复消息给b(b收到消息响应，b认为可以连通b, 此时a和b正式建立连接)
* A 和 B 建立了连接之后，A 会马上发送数据的，一旦 A 发送数据，则很多问题都得到了解决。
* 如果建立连接和，A不发送数据，我们在程序设计的时候，可以要求开启 keepalive 机制，即使没有真实的数据包，也有__探活包__。
* 作为服务端 B 的程序设计者，对于 A 这种长时间不发包的客户端，可以主动关闭，从而空出资源来给其他客户端使用。
* 在建立连接的过程中，双方都需要维护一个状态机:
![tcp_conn.jpg](https://i.loli.net/2021/03/20/eCJDAPuUWjInmwz.jpg)

### 约定初始数据包序号 ?

## TCP 四次挥手

![tcp_close.jpg](https://i.loli.net/2021/03/20/MpHnijPGKdqWhN8.jpg)

## TCP 状态机
![tcp状态机.jpg](https://i.loli.net/2021/03/20/TM49hNKdBzRGZJ2.jpg)
* 阿拉伯数字的序号，是连接过程中的顺序，大写中文数字的序号，是连接断开过程中的顺序。
* 加粗的实线是客户端 A 的状态变迁，加粗的虚线是服务端 B 的状态变迁。
